name: Generate CPP README markdown files

on:
  push:
    branches:
      - main
    paths:
      - 'generate-md.py'
      - 'CPP-*/cpp-*.xml'

permissions:
  contents: write

jobs:
  generate-and-commit:
    if: github.actor != 'github-actions[bot]'
    name: Run generate-md.py and commit README updates
    runs-on: ubuntu-latest

    steps:
      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.KADEE_ACTION_BOT_APP_ID }}
          private-key: ${{ secrets.KADEE_ACTION_BOT_PRIVATE_KEY }}
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run generate-md.py scripts
        shell: bash
        run: python generate-md.py

      - name: Commit README updates in CPP-* directories
        if: always()
        shell: bash
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: |
          set -euo pipefail
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          staged=false

          # Stage modified or added README files
          # 1) staged/modified relative to HEAD
          while IFS= read -r -d '' f; do
            git add -f "$f"
            staged=true
          done < <(git diff --name-only --diff-filter=AM HEAD -z | grep -z -E '^CPP-[^/]+/README\.md$' || true)

          # 2) untracked README files that match the pattern
          while IFS= read -r -d '' f; do
            git add -f "$f"
            staged=true
          done < <(git ls-files --others --exclude-standard -z | grep -z -E '^CPP-[^/]+/README\.md$' || true)

          if [ "$staged" = false ]; then
            echo "No README.md updates to commit."
            exit 0
          fi

          git commit -m "Updated markdown CPP descriptions"
          
          # Push back to the branch that triggered the workflow
          BRANCH="${GITHUB_REF#refs/heads/}"
          git push origin "HEAD:${BRANCH}"
